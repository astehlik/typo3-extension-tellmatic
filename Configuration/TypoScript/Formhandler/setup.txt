
plugin.Tx_Formhandler.settings.predef {

	tellmatic_request_subscription < .formhandler_subscription_request_subscription
	tellmatic_request_subscription {

		name = Tellmatic - Request subscription

		templateFile = EXT:tellmatic/Resources/Private/Templates/Formhandler/RequestSubscription.html
		langFile.2 = EXT:tellmatic/Resources/Private/Language/Formhandler.xml

		isErrorMarker >
		isErrorMarker {
			default = has-error
			global (
				<div class="alert alert-warning">
					<strong>###LLL:global_error_header###</strong><br />
					###LLL:global_error_message###
					###error_tellmatic###
				</div>
			)
		}

		singleErrorTemplate >
		singleErrorTemplate {
			totalWrap = <p class="help-block">|</p>
			singleWrap = <strong>|</strong><br />
		}

		validators.20.class = Sto\Tellmatic\Formhandler\SubscribeValidator
		validators.20.config {
			fields {
				email.mapping = email
				f0.mapping = gender
				f1.mapping = first_name
				f2.mapping = last_name
			}
		}

		finishers {

			1 >
			1.class = Sto\Tellmatic\Formhandler\SubscriptionStateSwitch
			1.config {

				fields.email.mapping = email

				// For new subscribers we create an auth code that will trigger a tellmatic subscription on validation.
				newSubscriber < plugin.Tx_Formhandler.settings.predef.formhandler_subscription_request_subscription.finishers.1.config.finishersNewSubscriber

				// Store the record in the Tellmatic database.
				newSubscriber.10 >
				newSubscriber.10.class = Sto\Tellmatic\Formhandler\SubscribeFinisher
				newSubscriber.10.config {
					doNotSendEmails = 1
					addressState = waiting
					memo = User filled out initial subscribe request.
					fields < plugin.Tx_Formhandler.settings.predef.tellmatic_request_subscription.validators.20.config.fields
				}

				// Reconfigure auth code generation.
				newSubscriber.20.config >
				newSubscriber.20.config {
					independentMode = 1
					identifier = TEXT
					identifier.data = GP:tx_formhandler_subscription|email
					context = tellmatic_subscription
					authCodePage = {$plugin.formhandler_subscription.confirmSubscriptionPID}
				}

				// Unconfirmed subscribers will be handled as new subscribers.
				existingUnconfirmedSubscriber < .newSubscriber

				// Existing & confirmed subscribers will get an auth code mail.
				existingConfirmedSubscriber < plugin.Tx_Formhandler.settings.predef.formhandler_subscription_request_subscription.finishers.1.config.finishersExistingConfirmedSubscriber

				// Reconfigure auth code generation.
				existingConfirmedSubscriber.20.config >
				existingConfirmedSubscriber.20.config < .newSubscriber.20.config
				existingConfirmedSubscriber.20.config {
					authCodePage = {$plugin.formhandler_subscription.updateSubscriptionFormPID}
					action = accessForm
				}
			}
		}
	}

	tellmatic_confirm_subscription < .formhandler_subscription_confirm_subscription
	tellmatic_confirm_subscription {

		name = Tellmatic - Confirm subscription

		preProcessors {

			10.config {
				doNotInvalidateAuthCode = 1
				mergeIndependentIdentifierToGP = email
			}

			20.class = Sto\Tellmatic\Formhandler\SubscriptionDataPreProcessor
			20.config {
				fields.email.mapping = email
				mapAddressFields {
					f0 = gender
					f1 = first_name
					f2 = last_name
				}
			}

			30 < plugin.Tx_Formhandler.settings.predef.tellmatic_request_subscription.finishers.1.config.newSubscriber.10
			30.config.addressState = confirmed
			30.config.memo = User confirmed his subscription by submitting valid auth code.

			40.class = Tx\FormhandlerSubscription\Finisher\InvalidateAuthCodeDB
		}
	}

	tellmatic_request_update < .formhandler_subscription_request_update
	tellmatic_request_update {

		name = Tellmatic - Request update

		langFile.2 = EXT:tellmatic/Resources/Private/Language/Formhandler.xml

		isErrorMarker >
		isErrorMarker < plugin.Tx_Formhandler.settings.predef.tellmatic_request_subscription.isErrorMarker
		singleErrorTemplate >
		singleErrorTemplate < plugin.Tx_Formhandler.settings.predef.tellmatic_request_subscription.singleErrorTemplate

		finishers {

			1 < plugin.Tx_Formhandler.settings.predef.tellmatic_request_subscription.finishers.1

			1.config {

				// New subscribers only get an email with a notice that they aren't subscribed, no database record is created, no auth code is generated.
				finishersNewSubscriber {
					10 >
					20 >
				}

				finishersExistingConfirmedSubscriber {
					30.config.user.subject.data = LLL:{$plugin.formhandler_subscription.globalLanguageFile}:request_update_email_user_subject
				}
			}
		}
	}

	tellmatic_update_subscription < .formhandler_subscription_update_subscription
	tellmatic_update_subscription {

		name = Tellmatic - Update subscription

		templateFile = EXT:tellmatic/Resources/Private/Templates/Formhandler/UpdateSubscription.html
		langFile.2 = EXT:tellmatic/Resources/Private/Language/Formhandler.xml

		isErrorMarker >
		isErrorMarker < plugin.Tx_Formhandler.settings.predef.tellmatic_request_subscription.isErrorMarker
		singleErrorTemplate >
		singleErrorTemplate < plugin.Tx_Formhandler.settings.predef.tellmatic_request_subscription.singleErrorTemplate

		preProcessors.10.config.mergeIndependentIdentifierToGP = email

		preProcessors.20 < plugin.Tx_Formhandler.settings.predef.tellmatic_confirm_subscription.preProcessors.20

		validators.20 < plugin.Tx_Formhandler.settings.predef.tellmatic_request_subscription.validators.20

		finishers {

			10 >
			10.class = Tx\FormhandlerSubscription\Finisher\ValidateAuthCodeIdentifier
			10.config {
				identifier = TEXT
				identifier.data = GP:tx_formhandler_subscription|email
			}

			20 >
			20 < plugin.Tx_Formhandler.settings.predef.tellmatic_request_subscription.finishers.1.config.newSubscriber.10
			20.config {
				addressState = confirmed
				memo = User updated his subscription by using a valid auth code.
			}
		}

	}

	tellmatic_remove_subscription < .formhandler_subscription_remove_subscription
	tellmatic_remove_subscription {

		name = Tellmatic - Remove subscripion

		templateFile = EXT:tellmatic/Resources/Private/Templates/Formhandler/RemoveSubscription.html
		langFile.2 = EXT:tellmatic/Resources/Private/Language/Formhandler.xml

		isErrorMarker >
		isErrorMarker < plugin.Tx_Formhandler.settings.predef.tellmatic_request_subscription.isErrorMarker
		singleErrorTemplate >
		singleErrorTemplate < plugin.Tx_Formhandler.settings.predef.tellmatic_request_subscription.singleErrorTemplate

		preProcessors.10.config.mergeIndependentIdentifierToGP = email

		validators.20.class = Tx\FormhandlerSubscription\Finisher\ValidateAuthCodeIdentifier
		validators.20.config {
			identifier = TEXT
			identifier.data = GP:tx_formhandler_subscription|email
		}

		validators.30.class = Sto\Tellmatic\Formhandler\UnsubscribeValidator
		validators.30.config {

			email = TEXT
			email.data = GP:tx_formhandler_subscription|email

			newsletterId = TEXT
			newsletterId.data = GP:nl_id

			historyId = TEXT
			historyId.data = GP:h_id

			queueId = TEXT
			queueId.data = GP:q_id

		}

		finishers.10 >
		finishers.10.class = Tx\FormhandlerSubscription\Finisher\InvalidateAuthCodeDB
	}
}