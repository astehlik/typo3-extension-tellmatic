
plugin.Tx_Formhandler.settings.predef {

	tellmatic_request_subscription < .formhandler_subscription_request_subscription
	tellmatic_request_subscription {

		debug = 1

		name = Tellmatic - Request subscription

		validators.20.class = Sto\Tellmatic\Formhandler\SubscribeRequest
		validators.20.config {

			validateOnly = 1

			fields {
				email = email
				f0.mapping = last_name
				f1.mapping = first_name
				f2.mapping = gender
			}
		}

		finishers {

			1 >
			1.class = Sto\Tellmatic\Formhandler\SubscriptionStateSwitch
			1.config {

				// For new subscribers we create an auth code that will trigger a tellmatic subscription on validation.
				newSubscriber < plugin.Tx_Formhandler.settings.predef.formhandler_subscription_request_subscription.finishers.1.config.finishersNewSubscriber

				// Store the record in the Tellmatic database.
				newSubscriber.10 >
				newSubscriber.10 < plugin.Tx_Formhandler.settings.predef.tellmatic_request_subscription.validators.20
				newSubscriber.10.config {
					addressState = waiting
					doNotSendEmails = 1
				}

				// Reconfigure auth code generation.
				newSubscriber.20.config >
				newSubscriber.20.config {
					independentMode = 1
					identifier = TEXT
					identifier.data = GP:tx_formhandler_subscription|email
					context = tellmatic_subscription
				}

				// Unconfirmed subscribers will be handled as new subscribers.
				existingUnconfirmedSubscriber < .newSubscriber

				// Existing & confirmed subscribers will get an auth code mail.
				existingConfirmedSubscriber < plugin.Tx_Formhandler.settings.predef.formhandler_subscription_request_subscription.finishers.1.config.finishersExistingConfirmedSubscriber

				// Reconfigure auth code generation.
				existingConfirmedSubscriber.20.config >
				existingConfirmedSubscriber.20.config < .newSubscriber.20.config
			}
		}
	}

	tellmatic_confirm_subscription < .formhandler_subscription_confirm_subscription
	tellmatic_confirm_subscription {

		name = Tellmatic - Confirm subscription

		// We need to tell the auth code validator that we work in independent mode.
		preProcessors.10.config {
			independentMode = 1
			context = tellmatic_subscription
		}
	}

	tellmatic_request_update < .formhandler_subscription_request_update
	tellmatic_request_update {
		name = Tellmatic - Request update
	}

	tellmatic_update_subscription < .formhandler_subscription_update_subscription
	tellmatic_update_subscription {
		name = Tellmatic - Update subscription
	}

	tellmatic_remove_subscription < .formhandler_subscription_remove_subscription
	tellmatic_remove_subscription {
		name = Tellmatic - Remove subscripion
	}
}